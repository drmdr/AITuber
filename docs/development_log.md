# 開発ログ

## 2025-07-03

### 担当
- AIアシスタント Cascade

### 1. X Posterシステムの機能改善と自動化

- **ユニットテストの導入**:
  - `x_poster/test_greet_poster.py` を `unittest` フレームワークで刷新。
  - Gemini APIの呼び出しをモック化し、NFT関連・非関連サービスで適切なツイート文言が生成されるかを検証するテストを実装した。

- **GitHub Actions CI/CDの強化**:
  - `.github/workflows/x_auto_tweet.yml` に `test` ジョブを追加。
  - `tweet` ジョブが `test` ジョブの成功に依存するよう設定し、テストが通らない限り投稿されない安全なデプロイフローを構築した。

- **画像生成プロンプトの高品質化**:
  - `config.public.json` に詳細なキャラクター設定 (`character_description`) を追加。
  - `morning_greet_poster.py` を修正し、この詳細設定を読み込んで、より高品質な画像を生成するプロンプトを動的に組み立てるようにした。

- **仕様書の更新**:
  - `docs/spec.md` に「開発ワークフロー」の項を追加し、Gitへのコミットとプッシュは原則としてAIアシスタントが担当するルールを明記した。

### 2. 画像投稿機能のデバッグ

- **課題**: GitHub Actions経由でのツイート投稿時に、画像が添付されない問題が発生。
- **デバッグ過程と解決策**:
  1.  **原因特定①**: ログから「Vertex AI APIがプロジェクトで有効化されていない」(`403 SERVICE_DISABLED`) エラーを発見。
      - **対応**: ユーザーにAPIの有効化を依頼。
  2.  **原因特定②**: API有効化後、今度は「リストのインデックスが範囲外」(`list index out of range`) エラーが発生。APIから画像が返されていない（セーフティフィルターの可能性）と推測。
      - **対応**: `morning_greet_poster.py` を修正し、APIの応答を詳細にログ出力するよう変更。
  3.  **原因特定③**: 詳細ログから「画像の保存にPILモジュールが必要」というエラーを特定。画像のメタデータ保存に失敗していることが判明。
      - **対応**: `morning_greet_poster.py` を再修正し、画像の保存時にメタデータを含めない設定 (`include_generation_parameters=False`) に変更。これにより画像投稿が成功した。

### 3. 機能追加：英語版ツイートへの画像添付

- **ユーザー要望**: 日本語ツイートだけでなく、10分後に返信として投稿される英語ツイートにも同じ画像を添付したい。
- **対応**: `morning_greet_poster.py` のメインロジックを修正。最初に生成した画像のパスを英語ツイート投稿時にも渡し、同じ画像が添付されるようにした。

---



## 2025-06-25

### 1. キャラクター設定の反映と修正

- **問題点**: `AITuber.py` の `interactive_mode` において、Geminiモデルの初期化が不適切で、`config.local.json` に定義されたキャラクターのペルソナ（性格・口調）が会話に反映されていなかった。
- **修正内容**:
    - `interactive_mode` 内のモデル初期化処理をリファクタリングし、`system_instruction` としてキャラクターのペルソナ(`full_persona`)が正しく渡されるように修正した。
    - これにより、会話中の応答がキャラクター設定に沿ったものになることを確認した。

### 2. `config.local.json` の設定値の修正

- **問題点**: 過去の修正で、ユーザーの意図しない形で `config.local.json` が書き換えられ、キャラクター設定（AIと名乗らない、一人称、挨拶など）が失われていた。
- **修正内容**:
    - ユーザーからの指摘に基づき、`config.local.json` を再度修正。
    - **ペルソナ**: 「AI」という単語を削除。
    - **一人称**: 「ウチ」に統一。
    - **挨拶**: 「Gmonamin!」で始まる形式に統一。
    - **自己紹介**: 「AIチューバー」という記述を削除。
    - JSON構文エラー（コンマ不足）も併せて修正した。

### 3. 仕様書 (`docs/spec.md`) の更新

- **背景**: 今後の開発でキャラクター設定の逸脱を防ぐため、絶対的な指針として仕様書に明記する必要があった。
- **更新内容**:
    - 「3.1. キャラクター設定の厳守」セクションに、以下の詳細な定義とルールを追記した。
        - **基本設定**: 名前（モナミン）、一人称（ウチ）、口調（えせ関西弁）、挨拶の具体的な内容。
        - **絶対的な禁止・遵守事項**:
            1.  **AIと名乗らない**: AIやアシスタント等の自己言及の禁止。
            2.  **設定ファイルの尊重**: ユーザー指示なく `config` ファイルを変更することの禁止。
            3.  **キャラクター定義の優先**: 実装時は仕様書と設定ファイルを最優先とし、不明点はユーザーに確認すること。

### 4. 全体的な安定性の向上

- Gemini API TTSのクライアント初期化やインポート文など、プロジェクト全体でコードの品質と一貫性を向上させるための修正を複数実施した。

---

**今後の課題**: 
- 言語選択システムの安定性向上（batファイルの分割など）。
- 過去のミスを繰り返さないためのレビュー体制の構築。
